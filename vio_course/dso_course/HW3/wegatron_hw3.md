## DSO第三次作业
### 一、测试
1. 零空间测试
    在`EnergyFunctional::solveSystemF`函数中加入测试代码:
    ```c++

    // 加入的测试代码
    {
        std::cout << "===================== Test nullspace ============================" << std::endl;
        auto N = nullspaceN(); // 这里参考orthogonalize函数获取0空间的基
        std::cout << "N^T * H * N:\n" << N.transpose() * lastHS * N << "\n N^T *b:\n"
             << N.transpose() * lastbS << std::endl;
        std::cout << "-----------------------------------------------------------------" << std::endl;
    }

	VecX x;
	if(setting_solverMode & SOLVER_SVD) {
    // ...
    ```

    结果不为0, 因为第0帧加入了先验, 0空间的基在先验上构成的能量不为0.
    ```bash
    ===================== Test nullspace ============================
    N^T * H * N:
    27616.8  16666.7 -19544.1 -16932.1  26847.2  7503.75   1631.1
    16666.7   154638   -33699  -157280  17873.4  65981.9  11061.2
    -19544.1   -33699  33805.3  33901.7   -24371 -18362.2 -14337.7
    -16932.1  -157280  33901.7   193750 -20774.6 -61258.6 -11456.8
    26847.2  17873.4   -24371 -20774.6  40501.7  10263.3  5161.16
    7503.75  65981.9 -18362.2 -61258.6  10263.3  71274.6   6822.2
    1631.1  11061.2 -14337.7 -11456.8  5161.16   6822.2  9667.15
    N^T *b:
    20.4462
    -52.169
    104.362
    45.8786
    -31.2787
    -56.009
    -95.7322
    -----------------------------------------------------------------
    STEPS: A 1.6; B 13.3; R 4.6; T 9.2. 	ACCEPT 0 (L -1.00, dir nan, ss 1.0): 	A(2167796.997240)=(AV 4.284). Num: A(14765) + M(1418228); ab -0.000055 -4.240358!
    ===================== Test nullspace ============================
    N^T * H * N:
    27616.8  16666.7 -19544.1 -16932.1  26847.2  7503.75   1631.1
    16666.7   154638   -33699  -157280  17873.4  65981.9  11061.2
    -19544.1   -33699  33805.3  33901.7   -24371 -18362.2 -14337.7
    -16932.1  -157280  33901.7   193750 -20774.6 -61258.6 -11456.8
    26847.2  17873.4   -24371 -20774.6  40501.7  10263.3  5161.16
    7503.75  65981.9 -18362.2 -61258.6  10263.3  71274.6   6822.2
    1631.1  11061.2 -14337.7 -11456.8  5161.16   6822.2  9667.32
    N^T *b:
    5.20669
    -185.022
    165.585
    186.79
    -47.3433
    -142.001
    -126.849
    -----------------------------------------------------------------
    STEPS: A 0.0; B 0.3; R 1.3; T 3.2. 	ACCEPT 1 (L -1.60, dir 0.26, ss 1.0): 	A(2155426.493213)=(AV 4.268). Num: A(14794) + M(1418228); ab -0.000052 -4.280617!
    ===================== Test nullspace ============================
    N^T * H * N:
    27616.8  16666.7 -19544.1 -16932.1  26847.2  7503.75   1631.1
    16666.7   154638   -33699  -157280  17873.4  65981.9  11061.2
    -19544.1   -33699  33805.3  33901.7   -24371 -18362.2 -14337.7
    -16932.1  -157280  33901.7   193750 -20774.6 -61258.6 -11456.8
    26847.2  17873.4   -24371 -20774.6  40501.7  10263.3  5161.16
    7503.75  65981.9 -18362.2 -61258.6  10263.3  71274.6   6822.2
    1631.1  11061.2 -14337.7 -11456.8  5161.16   6822.2   9666.8
    N^T *b:
    25.2582
    -112.537
    121.902
    106.153
    -50.9209
    -108.594
    -106.851
    
    ```
    
2. 在 `setting.cpp` ⽂件中把 `setting_solverMode` 上加上 `SOLVER_REMOVE_POSEPRIOR` 变量后变为很接近与0的量. 理论上应该得到是0, 但是由于数值计算的误差得到的结果接近与0.
    ```bash
    ===================== Test nullspace ============================
    N^T * H * N:
    -4.52497e-06  1.05153e-06 -6.34261e-07  -1.2268e-06   1.0517e-07 -1.33673e-05    -0.284177
    1.00052e-06   4.2948e-05 -1.10027e-05 -4.08352e-05 -5.63629e-06 -0.000141477    -0.243585
    -7.64699e-07 -1.09774e-05 -7.16992e-06  5.94292e-06 -5.58152e-06  3.18337e-06    -0.180355
    -1.15822e-06 -4.17168e-05  5.93113e-06   3.7708e-05  3.24672e-06  0.000116267   -0.0797439
    9.27117e-08 -5.56558e-06 -5.15588e-06  3.17173e-06 -2.00315e-06  4.21137e-06    -0.353041
    -1.33847e-05 -0.000142139  3.55457e-06  0.000119642  4.12384e-06  0.000311053     -2.08522
    -0.284177    -0.243585    -0.180355   -0.0797438    -0.353041     -2.08522    -0.283747
    N^T *b:
    -0.274127
    0.322603
    -0.147095
    0.00600801
    -0.193313
    -0.302229
    0.0808178
    -----------------------------------------------------------------
    STEPS: A 2.4; B 24.9; R 1.6; T 3.0. 	ACCEPT 0 (L -1.00, dir nan, ss 1.0): 	A(2744800.796974)=(AV 5.208). Num: A(12651) + M(362782); ab -0.000072 -4.252302!
    ===================== Test nullspace ============================
    N^T * H * N:
    -4.52944e-06   9.1925e-07 -3.62942e-07 -1.08068e-06  2.63113e-07 -1.35184e-05    -0.284177
    1.08968e-06  4.23758e-05 -1.10687e-05 -4.02092e-05 -5.59754e-06 -0.000142284    -0.243585
    -5.25138e-07 -1.12518e-05 -7.42552e-06    6.104e-06 -5.35698e-06  3.62385e-06    -0.180355
    -1.27334e-06 -4.03123e-05  6.01391e-06  3.60751e-05  3.09815e-06  0.000119796    -0.079744
    2.32384e-07 -5.69421e-06 -4.93553e-06  3.34765e-06 -1.41907e-06  3.91314e-06    -0.353041
    -1.38003e-05 -0.000142949  3.67733e-06   0.00012033  3.90802e-06  0.000304393     -2.08522
    -0.284177    -0.243585    -0.180355   -0.0797441    -0.353041     -2.08522      1.06887
    N^T *b:
    -0.270927
    0.320613
    -0.150581
    0.00952637
    -0.190173
    -0.299335
    0.0917732
    -----------------------------------------------------------------
    STEPS: A 0.0; B 0.2; R 0.3; T 0.7. 	ACCEPT 1 (L -1.60, dir -0.03, ss 1.0): 	A(2734796.514355)=(AV 5.188). Num: A(12699) + M(362782); ab -0.000064 -4.276259!
    LOG 963: 5.188 fine. Res: 12699 A, 0 L, 365626 M; (95001 / 104506) forceDrop. a=-0.000064, b=-4.276259. Window 143 (7)
    Coarse Tracker tracked ab = -0.013154 -2.849593 (exp 8.163228). Res 3.318919!
    Coarse Tracker tracked ab = -0.016127 -3.456457 (exp 8.213053). Res 3.623547!
    Coarse Tracker tracked ab = -0.010857 -3.445205 (exp 8.213053). Res 3.954988!
    Coarse Tracker tracked ab = -0.013577 -2.941092 (exp 8.213053). Res 3.974820!
    SPARSITY:  MinActDist 1.400000 (need 2000 points, have 1839 points)!
    OPTIMIZE 2380 pts, 12392 active res, 0 lin res!
    Initial Error       	A(2539310.049028)=(AV 5.000). Num: A(12699) + M(365626); ab -0.013577 -2.941092!
    ===================== Test nullspace ============================
    N^T * H * N:
    -4.02082e-06  1.06648e-06 -9.71011e-07 -1.22559e-06  7.17589e-07 -1.32973e-05    -0.282679
    1.10172e-06  4.34855e-05 -1.09957e-05 -4.11632e-05 -5.63397e-06 -0.000138672    -0.245199
    -1.11847e-06 -1.10045e-05 -6.85074e-06  5.85122e-06 -6.00993e-06  3.95478e-06     -0.17949
    -1.10983e-06 -4.18786e-05  5.85793e-06  3.76594e-05  3.26339e-06  0.000115453   -0.0846811
    5.80696e-07 -5.69747e-06 -5.63009e-06  3.27607e-06 -1.12952e-06  4.05157e-06    -0.330167
    -1.35532e-05 -0.000138458  3.88324e-06  0.000116014  3.77478e-06  0.000293266     -1.91812
    -0.282679    -0.245199     -0.17949   -0.0846812    -0.330166     -1.91812     0.547038
    N^T *b:
    -0.27475
    0.32511
    -0.149313
    0.00625786
    -0.193458
    -0.274636
    0.100717
    -----------------------------------------------------------------
    STEPS: A 0.8; B 8.3; R 3.8; T 6.0. 	ACCEPT 0 (L -1.00, dir nan, ss 1.0): 	A(2500255.338216)=(AV 5.148). Num: A(11791) + M(365626); ab -0.000050 -4.326579!
    ===================== Test nullspace ============================
    N^T * H * N:
    -3.68163e-06  9.58086e-07  -5.8261e-07 -1.11772e-06  8.94995e-07 -1.30881e-05     -0.28268
    8.96963e-07  4.33265e-05  -1.0931e-05 -4.10854e-05 -5.80711e-06 -0.000137412    -0.245199
    -6.06275e-07 -1.09765e-05 -8.03008e-06  5.76379e-06  -5.5311e-06  3.76226e-06    -0.179489
    -1.06515e-06 -4.17763e-05   5.6715e-06  3.77978e-05  3.37704e-06    0.0001128   -0.0846809
    1.2978e-06 -5.67673e-06 -5.71964e-06  3.25114e-06 -7.26761e-07   4.1135e-06    -0.330166
    -1.37006e-05 -0.000137057  4.08192e-06  0.000114652  3.41888e-06  0.000295436     -1.91812
    -0.28268    -0.245199    -0.179489   -0.0846811    -0.330167     -1.91812    -0.155903
    N^T *b:
    -0.268377
    0.324612
    -0.164757
    0.00265636
    -0.188475
    -0.302315
    0.117095
    -----------------------------------------------------------------
    STEPS: A 0.0; B 0.1; R 0.6; T 1.2. 	ACCEPT 1 (L -1.60, dir -0.03, ss 1.0): 	A(2494155.149666)=(AV 5.139). Num: A(11805) + M(365626); ab -0.000047 -4.339775!
    ===================== Test nullspace ============================
    N^T * H * N:
    -4.14377e-06  9.55038e-07  -1.1662e-06  -1.1128e-06  3.84617e-07  -1.3359e-05    -0.282679
    1.03373e-06  4.41731e-05 -1.09695e-05 -4.20723e-05 -5.62888e-06 -0.000136551    -0.245199
    -1.01865e-06 -1.10316e-05 -6.68947e-06  5.87221e-06 -5.71176e-06  3.91545e-06     -0.17949
    -1.12305e-06 -4.22167e-05  5.96052e-06   3.8104e-05    3.323e-06  0.000114411   -0.0846812
    5.44677e-07 -5.61866e-06 -5.65843e-06  3.24073e-06 -1.19453e-06  3.34516e-06    -0.330166
    -1.33313e-05 -0.000136897  3.62085e-06   0.00011476  3.54788e-06  0.000293687     -1.91812
    -0.282679    -0.245199     -0.17949   -0.0846812    -0.330167     -1.91812     -1.59894
    N^T *b:
    -0.268351
    0.326127
    -0.163531
    0.00249789
    -0.187887
    -0.293705
    0.12068
    ----------------------------------------------------------------- 
    ```

    3. 在第一种情况下, 分别对①滑窗内帧的H,b(去掉prior和marg); ②prior先验H,b; ③marg的H,b. 进⾏零空间试.
    在`AccumulatedTopHessianSSE::stitchDoubleInternal`函数中添加如下代码:
    ```c++
    // 这里新建了一个test_data.h和test_data.cpp用来存取H_prior和b_prior
    MatXX &H_prior = get_h_prior(); H_prior.setZero(nframes[tid]*8+CPARS, nframes[tid]*8+CPARS);
    VecX &b_prior = get_b_prior(); b_prior.setZero(nframes[tid]*8+CPARS);
    
    // 记录先验
    H_prior.diagonal().head<CPARS>() += EF->cPrior;
    b_prior.head<CPARS>() += EF->cPrior.cwiseProduct(EF->cDeltaF.cast<double>());

	H[tid].diagonal().head<CPARS>() += EF->cPrior;
	b[tid].head<CPARS>() += EF->cPrior.cwiseProduct(EF->cDeltaF.cast<double>());
	for(int h=0;h<nframes[tid];h++)
	{
        H[tid].diagonal().segment<8>(CPARS+h*8) += EF->frames[h]->prior;
        b[tid].segment<8>(CPARS+h*8) += EF->frames[h]->prior.cwiseProduct(EF->frames[h]->delta_prior);

        // 记录先验
        H_prior.diagonal().segment<8>(CPARS+h*8) += EF->frames[h]->prior;
        b_prior.segment<8>(CPARS+h*8) += EF->frames[h]->prior.cwiseProduct(EF->frames[h]->delta_prior);
	}
    ```

    再修改`EnergyFunctional::solveSystemF`函数中的测试代码:
    ```c++
    {
        std::cout << "===================== Test nullspace ============================" << std::endl;
        std::cout << "--------------lastHs, bs-------------------" << std::endl;
        auto N = nullspaceN();
        std::cout << "N^T * H * N:\n" << N.transpose() * lastHS * N << "\n N^T *b:\n"
             << N.transpose() * lastbS << std::endl;

        std::cout << "-------------remove marg, prior------------" << std::endl;
        std::cout << "N^T * H * N:\n" << N.transpose() * (lastHS - HM -get_h_prior()) * N << "\n N^T *b:\n"
                  << N.transpose() * (lastbS-bM_top-get_b_prior()) << std::endl;

        std::cout << "---------------marg------------------------" << std::endl;
        std::cout << "N^T * H * N:\n" << N.transpose() * HM * N << "\n N^T *b:\n"
                  << N.transpose() * bM_top << std::endl;

        std::cout << "---------------prior-----------------------" << std::endl;
        std::cout << "N^T * H * N:\n" << N.transpose() * get_h_prior() * N << "\n N^T *b:\n"
                  << N.transpose() * get_b_prior() << std::endl;
        std::cout << "-----------------------------------------------------------------" << std::endl;
    }
    ```

    得到的结果为除了prior, 其他都是0. $\mathbf{N^T H_{prior} N}$的对角线上有6个非0项, 对应旋转和平移.
    ```bash
    ===================== Test nullspace ============================
    --------------lastHs, bs-------------------
    N^T * H * N:
    5e+09  1.20899e-08  9.77578e-08 -7.43346e-07 -1.67894e-06   5.8246e-07  4.88363e-07
    5.27661e-08        5e+09  9.45388e-09 -3.13872e-06   1.0024e-07  4.97746e-07 -1.46758e-07
    1.5478e-07  7.60612e-08        5e+09  2.14689e-07 -2.80638e-07 -1.42077e-07  -8.3913e-09
    9.25758e-07  1.72869e-06 -8.37375e-08  4.99984e+10 -5.57784e-07  1.66352e-06 -6.30758e-06
    8.84156e-07 -8.06602e-07  6.38222e-07 -1.16937e-06  4.99164e+10  1.03234e-06  2.08788e-06
    -6.65268e-07 -8.61435e-07  1.59804e-07  1.32539e-06  3.11958e-07  4.99154e+10  1.94428e-07
    2.71946e-07 -3.63216e-07  1.52737e-07 -4.47407e-06  2.05814e-06 -1.21963e-09  5.29044e+08
    N^T *b:
    1.96451e-10
    -4.91127e-11
    -1.09139e-10
    -2.02308e-08
    1.0652e-08
    -1.39335e-09
    712567
    -------------remove marg, prior------------
    N^T * H * N:
    -3.05147e-07  1.20899e-08  9.77578e-08 -7.43346e-07 -1.67894e-06   5.8246e-07  4.88363e-07
    5.27661e-08 -4.86655e-07  9.45388e-09 -3.13872e-06   1.0024e-07  4.97746e-07 -1.46758e-07
    1.5478e-07  7.60612e-08  1.11114e-06  2.14689e-07 -2.80638e-07 -1.42077e-07  -8.3913e-09
    9.25758e-07  1.72869e-06 -8.37375e-08 -9.27969e-06 -5.57784e-07  1.66352e-06 -6.30758e-06
    8.84156e-07 -8.06602e-07  6.38222e-07 -1.16937e-06 -3.25913e-07  1.03234e-06  2.08788e-06
    -6.65268e-07 -8.61435e-07  1.59804e-07  1.32539e-06  3.11958e-07 -2.37798e-06  1.94428e-07
    2.71946e-07 -3.63216e-07  1.52737e-07 -4.47407e-06  2.05814e-06 -1.21963e-09  5.29044e+08
    N^T *b:
    1.96451e-10
    -4.91127e-11
    -1.09139e-10
    -2.02308e-08
    1.0652e-08
    -1.39335e-09
    712567
    ---------------marg------------------------
    N^T * H * N:
    0 0 0 0 0 0 0
    0 0 0 0 0 0 0
    0 0 0 0 0 0 0
    0 0 0 0 0 0 0
    0 0 0 0 0 0 0
    0 0 0 0 0 0 0
    0 0 0 0 0 0 0
    N^T *b:
    0
    0
    0
    0
    0
    0
    0
    ---------------prior-----------------------
    N^T * H * N:
    5e+09           0           0           0           0           0           0
    0       5e+09           0           0           0           0           0
    0           0       5e+09           0           0           0           0
    0           0           0 4.99984e+10           0           0           0
    0           0           0           0 4.99164e+10           0           0
    0           0           0           0           0 4.99154e+10           0
    0           0           0           0           0           0           0
    N^T *b:
    0
    0
    0
    0
    0
    0
    0
    -----------------------------------------------------------------
    STEPS: A 0.0; B 3.3; R 4.5; T 23.8. 	REJECT 0 (L -1.00, dir nan, ss 1.0): 	A(1279265.555315)=(AV 13.184). Num: A(920) + M(0); ab -0.000018 0.276184!
    ===================== Test nullspace ============================
    --------------lastHs, bs-------------------
    N^T * H * N:
    5e+09 -1.91829e-07 -4.61573e-07 -2.61148e-07  2.90756e-06  1.36401e-07  -1.6548e-06
    -3.65395e-07        5e+09 -1.74431e-07  3.69387e-06  1.57022e-07 -1.53011e-07  8.43422e-07
    1.376e-08  4.01146e-07        5e+09 -1.08258e-06 -2.96764e-07  2.37146e-07  9.99673e-07
    1.94245e-07 -5.15084e-06  1.93407e-08  4.99984e+10   1.9011e-06 -4.71827e-06 -1.09537e-05
    -5.36239e-06 -5.89557e-07  6.10805e-08  7.46317e-07  4.99164e+10 -3.48357e-07 -4.69787e-06
    -1.25856e-06 -4.95343e-07  5.44937e-08 -3.25646e-06 -8.53468e-07  4.99154e+10   8.5064e-07
    -1.60187e-06  9.35048e-07  1.06543e-06 -1.08927e-05 -3.12625e-06  8.31657e-07   9.3043e+08
    N^T *b:
    -134.278
    -23.8037
    -27.4014
    -236.1
    113.171
    85.8285
    756691
    -------------remove marg, prior------------
    N^T * H * N:
    2.691e-06 -1.91829e-07 -4.61573e-07 -2.61148e-07  2.90756e-06  1.36401e-07  -1.6548e-06
    -3.65395e-07 -6.55675e-07 -1.74431e-07  3.69387e-06  1.57022e-07 -1.53011e-07  8.43422e-07
    1.376e-08  4.01146e-07  5.79586e-07 -1.08258e-06 -2.96764e-07  2.37146e-07  9.99673e-07
    1.94245e-07 -5.15084e-06  1.93407e-08  2.99293e-05   1.9011e-06 -4.71827e-06 -1.09537e-05
    -5.36239e-06 -5.89557e-07  6.10805e-08  7.46317e-07 -1.93934e-06 -3.48357e-07 -4.69787e-06
    -1.25856e-06 -4.95343e-07  5.44937e-08 -3.25646e-06 -8.53468e-07  2.13446e-06   8.5064e-07
    -1.60187e-06  9.35048e-07  1.06543e-06 -1.08927e-05 -3.12625e-06  8.31657e-07   9.3043e+08
    N^T *b:
    -1.06229e-09
    4.98403e-10
    7.34872e-10
    4.45289e-09
    -1.33714e-08
    8.92032e-09
    756691
    ---------------marg------------------------
    N^T * H * N:
    0 0 0 0 0 0 0
    0 0 0 0 0 0 0
    0 0 0 0 0 0 0
    0 0 0 0 0 0 0
    0 0 0 0 0 0 0
    0 0 0 0 0 0 0
    0 0 0 0 0 0 0
    N^T *b:
    0
    0
    0
    0
    0
    0
    0
    ---------------prior-----------------------
    N^T * H * N:
    5e+09           0           0           0           0           0           0
    0       5e+09           0           0           0           0           0
    0           0       5e+09           0           0           0           0
    0           0           0 4.99984e+10           0           0           0
    0           0           0           0 4.99164e+10           0           0
    0           0           0           0           0 4.99154e+10           0
    0           0           0           0           0           0           0
    N^T *b:
    -134.278
    -23.8037
    -27.4014
    -236.1
    113.171
    85.8285
    0
    -----------------------------------------------------------------
    ```

4. marg的先验`SOLVER_ORTHOGONALIZE_POINTMARG`，⼀种是正交投影`SOLVER_ORTHOGONALIZE_SYSTEM`精度对比, 当采取marg或正交投影后精度有所上升, 其中正交投影相对比marg先验效果更好. 
注: 这里在tum的sequence_01上测试, 其中result的文件格式参考[这里](https://github.com/MichaelGrupp/evo/issues/175)做了修改.

    | 方法 | max | mean | median | min | rmse | sse | std |
    | --- | --- | ---- | ------ | --- | ----- | --- | --- |
    | none | 3.639481 | 0.289747 | 0.267187 | 0.085264 | 0.407982 | 26.798365 | 0.287221
    | marg | 3.6153 | 0.286646 | 0.271087 |	0.080369 | 0.403896 | 26.264300 |	0.284546 |
    | orth | 3.561652 | 0.290772 | 0.272211 | 0.093965 | 0.404958 | 26.074566 | 0.281856 |
    | both | 3.504807 | 0.288539 | 0.266765 | 0.092438 | 0.401035 | 25.893444 | 0.278521 |





### 二、修改代码
`accumulateLF_MT`作用验证, 在`AccumulatedTopHessianSSE::addPoint`中的`mode==1`处加入如下代码, 编译后, 程序正常运行, 说明并没有根据点的残差, 修改H, b.

>根据代码, `accumulateLF_MT`使用的是固定线性化点处的residual, 而`accumulateAF_LM`使用的是正常的residual. 而程序函数`FullSystem::flagPointsForRemoval`中那些符合2种情况(1. 因为residual太少造成了Out Of Boundary(这里考虑到将要被marginalize掉的帧的影响); 2. 主帧要被marginalize掉)的点的 residual设置为linearized. 但是这些点紧接着又会在`EnergyFunctional::marginalizePointsF()`中被marg掉, 被删除掉.最终也没有进入 `FullSystem::optimize()` 的优化过程中.
参考[DSO windowed optimization 代码 (2)](https://www.cnblogs.com/JingeTU/p/8586163.html)

```c++
for(EFResidual* r : p->residualsAll)
{
    if(mode==0)
    {
        if(r->isLinearized || !r->isActive()) continue;
    }
    if(mode==1)
    {
        if(!r->isLinearized || !r->isActive()) continue;
        std::cout << "using mode 1!!!" << std::endl;
        exit(__LINE__);
    }
    ...
```

这个函数存在的作用是
```c++
p->Hdd_accLF = 0;
p->bd_accLF = 0;
p->Hcd_accLF = 0;
```

若是要删除掉多余的变量, 可以将变量marg掉, 加入先验, 然后删掉.